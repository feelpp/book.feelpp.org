= Using the {feelpp} toolbox in the **MSO4SC Portal**
:toc: left
include::{partialsdir}/header-macro.adoc[]
include::{partialsdir}/header-uri.adoc[]
include::{partialsdir}/mso4sc-uri.adoc[]


This document will provide basic information:

* to connect to the {uri-msoportal-www}[Portal],
* to register an {feelpp} application,
* to purchase an {feelpp} application,
* to run an  {feelpp} application.

and it defines the role of <<enduser, *EndUser*>>.

An overview of the main portal functionalities is given in this <<overview,section>>.
This is followed by a brief description of the {feelpp} apps available and on the over-whole workflow
of actually running apps within the portal.

The user that have already an account on {uri-msoportal-www}[Portal] may skip the next section
and go directly to the section related to his/her role.


[[connect]]
== Get an account on *MSO4SC Portal*

Connect to {uri-msoportal-www}[MSOPortal]

image::PortalMSO4SC_login.png[login page MSOPortal]

* Click on *login*

You will be forwarded to IDM component to the portal.

image::PortalMSO4SC_idm.png[IDM component of MSOPortal]

* *Sign up* to get an account

image::PortalMSO4SC_signup.png[IDM component of MSOPortal]

TIP: do not check *gravatar* bug as it is buggy right now.

* Create an account there providing a valid email and a password.

Then you have to validate your account by following the instructions send
by the portal to your email address.

NOTE: Right now the portal *is not* using https protocol. As a consequence, the credentials `user/password` are
sent in clear. So be careful.

[[overview]]
== Overview of the Portal

image::PortalMSO4SC.png[Main page for MSOPortal]

the portal is split into several services:

* *Marketplace*, where you can add and/or purchase applications
* *Data Catalogue*, where you can add and/or retrieve data
* *Experiments*, where the app is setup and the simulation is launched
* *Visualization*, to access a Remote desktop to pre and/or post-processes your simulations

more details on:

* https://github.com/MSO4SC/MSOPortal/blob/master/portal/README.adoc[MSO4SC Front-end & Experiments Tool]
* https://business-api-ecosystem.readthedocs.io/en/v5.4.1/user-programmer-guide.html[*Marketplace* User manual]
* https://ckan.org/documentation-and-api/[*Data Catalogue* docs]

[NOTE]
====
For smooth operations of {uri-msoportal-www}{portal}, the following ports have to *open*:

* `3000`: *IDM*, the service responsible for authentification
* `5000`: *MarkePlace*
* `8000`: *Data Catalogue*

To check, you can use `nmap -p <port> portal.mso4sc.eu`.

You may need to contact your system admin to check and eventually open these ports.
====


[[feelpp_offerings]]
== {feelpp} Offerings in *Marketplace*

Currently the apps available in the *Marketplace* are given in the table bellow.
They are grouped into 4 categories:

* MagnetTools:
* Preprocessing:
* Simulations:
* Postprocessing:
* Bundles:

.Available {feelpp} apps
[options="header,footer"]
|===
| Offering            | Description        | Category    | Notes
| {feelpp} Offering | Basic demonstrator | Simulations |
|===

For details about settings up these apps please refer to these <<offering_setup, docs>>.
For the new user we recommend to read this guide. The impatient may go directly to the <<enduser, *EndUser*>>
 and try to run the basic demonstrator.

== Synopsis of the {feelpp} Offering

The {feelpp} offering is created by {feelpp} developers.
Any *EndUser* may purchase the offering following the <<purchase, generic procedure>>.
Then, he or she can run the purchased offering provided that some fields are filled properly as in this <<running, example>>.
Details for setup each offering will be giving in the <<offering_setup, next section>>.

Even if each offering is specific, what is going on under the hood is described here:

* deploy:
* running:
* undeploy:

[NOTE]
====
For app that requires some additional services like:

* {sregistry}: a registry holding singularity images,
* {girder}: a data management system

that requires additional settings (like credentials).

It is important to notify the *EndUser* that he has to get an account on these services.

For {sregistry} see this https://singularityhub.github.io/sregistry/credentials[manual]

For managing the account and this https://singularityhub.github.io/sregistry/client[note]
to setup the {sregistry} client.

As for {girder} ...
====


[[enduser]]
== *EndUser* role

TIP: when running into some strange portal behavior, first try to `logout/login` from the portal before reporting an issue.

TIP: make sure that you have access to {uri-sregistry-cesga}[sregistry] holding all the singularity images.
Right now its the only such service (see key `sregistry_url` in blueprints) available in the frame of the project.

[[purchase]]
=== Purchase an application

To purchase an application from the *Marketplace* you can either be *DevUser*
or a simple *EndUser*. The process is the following:

* connect to the {uri-msoportal-ckan-www}[*Marketplace*], in *Home* (top left Marketplace page) you will find all available apps (*All categories*).
* Click on *Add to Cart* to purchase the app you want.
* Click on *Shopping Cart* and *Checkout* to go on
** fill the required forms for *shipping address*
** provide a *shipping address* if not already defined
** provide a *billing address* if not already defined
** Finalize your order by clicking on *Checkout*

To use the app, you will have to wait that the owner/seller of the app validate
you order. To check the status of your order:

* go to *My Inventory*
* go to *Product Orders*

You shall be to see your products and their status in each product form.


[[data]]
=== Benchmarks and Examples Catalogue

Go to http://docs.feelpp.org/examples/0.105/[Examples] or http://docs.feelpp.org/benchmarks/0.105/[Benchmarks] {feelpp} guides to discover what is available

[[running]]
=== Running an {feelpp} application in *Experiments*

* Select *Create App Instance*
** define an ID
** select a registered app in the menu

At this point you should have a page with all the options that need to be filled before moving to *Deploy Instance*

image::Portal_HifiMagApp.png[ex: Main {feelpp} app]

The fields to fill may be grouped into categories:

* specs for running simulations
* HPC settings
* specs retrieving singularity images
* specs for singularity image

The *EndUser* shall only need to fill the fields related to the 1st and 2nd category.
The fields that are to be filled by *EndUser* are marked in *bold*.

The others fields are designed for more advanced users.


[NOTE]
====

.List of keys specs for running simulations
[options="header,footer"]
|===
| Key                           | Description                                 | Default                                                            | Notes
| **<toolbox>_case**                    | string that describe the location of the testcase                             | ``                       |
| *<toolbox slug name>_cli**                     | command line options                           |  "" |
|===

.List of keys to be defined for HPC settings
[options="header,footer"]
|===
| Key                        | Description              | Default          | Notes
| *slurm_n_tasks* | number of tasks to be used in parallel | 10 |  shall depends on batch system and selected partition
| *slurm_max_time* | maximum allowed time for run (minutes and seconds) | '00:30:00' |  shall depends on batch system and selected partition
|===

====

Once filled, click on *Create Instance*.
This will result in the executions on the selected HPC resource of the bootstrap script included in the app definition.

TIP: Any error will result in a message at the top of the page, bellow the menus.

The next step is to *Deploy Instance*:

* select the *ID*, you defined in the previous step, in the *App instance * menu
* click on *Deploy*, wait until the button in blue turns green

To *Run Instance*, the procedure is similar:

* select the *ID*, you defined in the previous step, in the *App instance* menu
* click on *RUN*

[TIP]
====
These step may take some minutes to be performed. A red button will indicates an error.
Check the message in the frame bellow the status button. To have more details about the actual error
is more tricky; we recommend to:

* make sure you have unchecked the cleanup option
* connect to the HPC resource
* move to the selected `base_dir/working_prefix<id>`
* check the logs

`base_dir`, `working_prefix` are filled within the portal *Experiments*.
The `<id>` is a random character generated by the deployment.

An other option is to run the app using the *orchestrator CLI*.
see https://github.com/MSO4SC/resources/blob/master/blueprint/feelpp/feelpp_test/README.adoc[this file] for details

====

You may cleanup your working by

* UnDeploy your Instance
** select the *ID*, you defined in the previous step, in the *App instance * menu
** click on *UnDeploy*

* Destroy your Instance
** select the *ID*, you defined in the previous step, in the *App instance * menu
** click on *Destroy*

[[post]]
=== Setting up an Remote Desktop resource in *Visualization*

* Go to {uri-msoportal-visu-www}[*Visualization*]
* Select *Settings*
* Define a Remote Desktop resource

[source,java]
----
include::{examplesdir}/remotedesktop.txt[]
----

=== Running an Remote Desktop resource in *Visualization*

* Go to *Visualization*
* Click *Desktop Available*
** Select your *Infrastructure* in the sliding menu

[NOTE]: if no *Remote desktop* is defined, you will receive a warning message. Create a <<post, *Setting*>>, then go back to this step.

** Click on *Create*
** Click either on *Desktop* or *View Only*

it should start a web page within your browser.
In this page you should be able to:

* start a 'terminal' and check the output of your simulation
* start a post-processing GUI:
** either by loading {uri-paraview-www}[{paraview}]
** or using singularity {uri-ensight-www}[{ensight}] image
* to quit just click on `Menu/logout` (top left)

For more details on using {paraview} or {ensight} please check XXXX.

[NOTE]
====
The result are stored in `${LUSTRE}/feel/<workdir_prefix>_<date>_<id>` if
you have chosen to use the `<hpc_volumes>` bindmount option: `${LUSTRE}/feel:/feel`.

Check the output of the script in `<basedir>/<workdir_prefix>_<date>_<id>`
to see the exact name of this directory.
====

[[offering_setup]]
== To go further

* MagnetTools:
* Preprocessing:
* Simulations:
** direct models
** CRB
* Postprocessing:

== References

* https://github.com/MSO4SC/MSOPortal/blob/master/portal/README.adoc#visualization--pre--post-tool[portal usage]
* https://raw.githubusercontent.com/MSO4SC/resources/master/blueprint/feelpp/feelpp_test/upload/blueprint.yaml[blueprints examples]
